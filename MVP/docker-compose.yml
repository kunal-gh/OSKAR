version: "3.8"

services:
  oskar-api:
    build: .
    container_name: oskar-api
    ports:
      - "8000:8000"
    environment:
      - OSKAR_API_KEY=oskar-dev-secret-key-123
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=oskar_secure_graph
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - neo4j
      - redis
    volumes:
      - huggingface_cache:/home/oskar_user/.cache/huggingface
    networks:
      - oskar-net
    restart: unless-stopped
    # 8GB memory limit is highly recommended given we load Whisper, DeBERTa, SBERT, etc.
    mem_limit: 8g

  neo4j:
    image: neo4j:5.12
    container_name: oskar-neo4j
    ports:
      - "7474:7474" # HTTP UI
      - "7687:7687" # Bolt UI
    environment:
      - NEO4J_AUTH=neo4j/oskar_secure_graph
    volumes:
      - neo4j_data:/data
    networks:
      - oskar-net
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: oskar-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - oskar-net
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: oskar-metrics
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prom_data:/prometheus
    networks:
      - oskar-net
    restart: unless-stopped

networks:
  oskar-net:
    driver: bridge

volumes:
  huggingface_cache:
  neo4j_data:
  redis_data:
  prom_data:
