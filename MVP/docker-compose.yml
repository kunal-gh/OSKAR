version: "3.8"

services:
  oskar-api:
    build: .
    container_name: oskar-api
    ports:
      - "8000:8000"
    environment:
      - OSKAR_API_KEY=oskar-dev-secret-key-123
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=oskar_secure_graph
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://oskar_user:oskar_pass@postgres:5432/oskar_db
      - QDRANT_HOST=qdrant
    depends_on:
      - neo4j
      - redis
      - postgres
      - qdrant
    volumes:
      - huggingface_cache:/home/oskar_user/.cache/huggingface
    networks:
      - oskar-net
    restart: unless-stopped
    mem_limit: 8g

  celery-worker:
    build: .
    container_name: oskar-worker
    command: celery -A src.celery_app worker --loglevel=info --concurrency=1
    environment:
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=oskar_secure_graph
      - DATABASE_URL=postgresql://oskar_user:oskar_pass@postgres:5432/oskar_db
      - QDRANT_HOST=qdrant
    depends_on:
      - redis
      - neo4j
      - postgres
      - qdrant
    volumes:
      - huggingface_cache:/home/oskar_user/.cache/huggingface
      - .:/app
    networks:
      - oskar-net
    restart: unless-stopped
    mem_limit: 8g

  neo4j:
    image: neo4j:5.12
    container_name: oskar-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/oskar_secure_graph
    volumes:
      - neo4j_data:/data
    networks:
      - oskar-net
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    container_name: oskar-postgres
    environment:
      - POSTGRES_USER=oskar_user
      - POSTGRES_PASSWORD=oskar_pass
      - POSTGRES_DB=oskar_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - oskar-net
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: oskar-vector-db
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - oskar-net
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: oskar-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - oskar-net
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: oskar-metrics
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prom_data:/prometheus
    networks:
      - oskar-net
    restart: unless-stopped

networks:
  oskar-net:
    driver: bridge

volumes:
  huggingface_cache:
  neo4j_data:
  redis_data:
  prom_data:
  postgres_data:
  qdrant_data:
